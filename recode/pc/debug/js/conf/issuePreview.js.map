{"version":3,"sources":["webpack:///./src/js/page/issuePreview/index.js"],"names":["fillComponents","arr","nodes","ue","document","body","children","pushDiv","tagNode","_childNodes","childNodes","data","i","length","_self","attributes","nodeValue","JSON","parse","push","type","id","shopId","kid","pushImg","node","src","srcExec","regs","domain","exec","pushText","text","_text","$","trim","replace","wrapP","tagHtml","innerHTML","arrs","split","img","_arr","cursor","indexOf","_arrs","br","j","tagName","outerHTML","makeFormData","name","val","groupId","attr","components","getContent","formCheck","title","content","checkContent","str","regtxt","reg","test","alert","btnPublishTopic","finished","publishTopic","option","_data","btnDisabled","fetch","post","url","get","done","success","window","noAlertMessage","setTimeout","location","href","$_CONFIG","group_domain","unsuccessful","init","btnActivate","fail","ok","html","css","on","e","preventDefault","formData","confirm","okCls","validate","groupid","imid","code","status","message"],"mappings":"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","file":"issuePreview.js","sourcesContent":["\n//组装数据\nvar fillComponents = function(arr) {\n    var nodes = ue.document.body.children;\n    //push数据到 components\n\n    var pushDiv = function(tagNode) {\n        var _childNodes = tagNode.childNodes;\n        var data = \"\";\n        for (var i = 0; i < _childNodes.length; i++) {\n            var _self = _childNodes[i].attributes;\n            if (_self) {\n                data = _self['data-info'].nodeValue;\n                break;\n            }\n\n        }\n        // var data = _childNodes[i].attributes['data-info'].nodeValue;\n        data = JSON.parse(data);\n        arr.push({\n            \"type\": data.type,\n            \"text\": \"\",\n            \"id\": data.id,\n            \"shopId\": data.shopId,\n            \"kid\": data.kid\n        });\n    };\n\n    var pushImg = function(node) {\n        var src = \"\",\n            srcExec = regs.src,\n            domain = srcExec.exec(node)[1];\n\n        if (domain) {\n            src = domain + srcExec.exec(node)[2];\n            arr.push({\n                \"type\": \"image\",\n                \"text\": \"\",\n                \"url\": src\n            });\n        }\n    };\n\n    var pushText = function(text) {\n        var _text = $.trim(text).replace(/&nbsp;/gi, ' ');\n        if (_text != \"\") {\n            arr.push({\n                \"type\": \"text\",\n                \"text\": _text\n            });\n        }\n    };\n    //主体标签事件\n\n    var wrapP = function(tagNode) {\n        // var childNodes = tagNode.childNodes;\n        var tagHtml = tagNode.innerHTML;\n\n        var arrs = tagHtml.split(regs.img);\n\n        for (var i = 0; i < arrs.length; i++) {\n            var _arr = arrs[i].replace(regs.cursor, '');\n            //图片\n            if (_arr.indexOf('<img') !== -1) {\n\n                pushImg(_arr);\n\n                //文本\n            } else if (_arr.indexOf('<br') !== -1) { //带有br\n                var _arrs = _arr.split(regs.br);\n                for (var j = 0; j < _arrs.length; j++) {\n                    var _text = _arrs[j];\n                    if (_text.indexOf('<br') == -1) {\n                        pushText(_text);\n                    }\n                }\n            } else {\n                pushText(_arr);\n            }\n        }\n    };\n\n    //遍历body下的节点 目前只有P 和DIV,img,text(text的为火狐标签溢出bug)\n    for (var i = 0; i < nodes.length; i++) {\n        var tagNode = nodes[i];\n\n        var tagName = tagNode.tagName;\n\n        switch (tagName) {\n            case \"P\":\n                wrapP(tagNode);\n                break;\n            case \"DIV\":\n                pushDiv(tagNode);\n                break;\n            case \"IMG\":\n                pushImg(tagNode.outerHTML);\n                break;\n            case \"#TEXT\":\n                pushText(tagNode.nodeValue);\n                break;\n        }\n\n    }\n};\n\nvar makeFormData = function() {\n    var name = $('[data-node=topicTitle]').val();\n    // var content = $('[data-node=editor]').val();\n    var groupId = $('[data-action=selectGroup]').attr('data-groupid');\n    var components = [];\n\n    // 转换内容数据 使用ue里面的数据，注释 之前textarea使用的数据\n    fillComponents(components);\n    /*\n    var inputList = $('[data-node=picAndShop]').find('textarea[data-action=textBox]');\n    $.each(inputList, function(i, n) {\n        components.push($(n).data('info'));\n    });\n    */\n    return {\n        \"name\": name,\n        \"groupId\": groupId,\n        \"components\": components,\n        \"richText\": ue.getContent()\n    };\n};\n\n//表单检测\nvar formCheck = function() {\n    //标题\n    var title = $('[data-node=topicTitle]').val();\n    //var content = $('[data-node=editor]').val();\n    var content = ue.getContent();\n    //群组ID\n    var groupId = $('[data-action=selectGroup]').attr('data-groupid');\n\n    var checkContent = function(str) {\n        var regtxt = /(<img|<div)/;\n        var reg = /(<p>|<\\/p>|<br>|<br\\/>|&nbsp;| )/gi;\n\n        if (regtxt.test(str) == true) {\n            return false;\n        }\n\n        if (str.replace(reg, \"\") == \"\") {\n            return true;\n        }\n    }\n\n    if ($.trim(title) === '') {\n        alert('请输入话题标题');\n        return false;\n    }\n    if (checkContent(content)) {\n        alert('话题内容不能为空');\n        return false;\n    }\n    if ($.trim(groupId) === '') {\n        alert('圈子不能为空');\n        return false;\n    }\n    return true;\n};\n//提交发布话题\nvar btnPublishTopic = $('[data-action=publishTopic]');\nvar finished = true;\nvar publishTopic = function(option) {\n    var _data = option;\n    btnDisabled(btnPublishTopic);\n    fetch.post(url.get('groupPublishTopic'), {\n        data: _data\n    }).done(function(data) {\n        if (data.success === true) {\n            window.noAlertMessage = 1;\n            setTimeout(function() {\n                window.location.href = $_CONFIG.group_domain + \"topic/detail?tid=\" + data.data.id + '&no_next=1';\n            }, 100)\n        } else {\n            unsuccessful.init(data);\n            btnActivate(btnPublishTopic);\n        }\n    }).fail(function() {\n        btnActivate(btnPublishTopic);\n        alert('发送失败，点击确定重新发布', {\n            ok: function() {\n                publishTopic(_data);\n            }\n        });\n    });\n};\nvar btnDisabled = function(node) {\n    finished = false;\n    node.html('发布中').css('background-color', '#d0d0d0');\n};\nvar btnActivate = function(node) {\n    finished = true;\n    node.html('发布').css('background-color', '#f95353');\n};\nbtnPublishTopic.on('click', function(e) {\n    e.preventDefault();\n    if (formCheck()) {\n        var formData = makeFormData();\n        var type = $('[data-action=selectGroup]').attr('data-grouptype');\n        if (type == 2) {\n            confirm('加入圈子后才能发布话题，确定要加入吗？', {\n                okCls: 'pc-btn',\n                ok: function() {\n                    fetch.post(url.get('joinCircle'), {\n                        validate: true,\n                        data: {\n                            groupid: $('[data-action=selectGroup]').attr('data-groupid'),\n                            imid: 'b_' + $_CONFIG['userId']\n                        }\n                    }).done(function(data /*, textStatus, jqXHR*/ ) {\n                        if (data && data.code === 200 && data.success) {\n                            if (data.data.status === 0) {\n                                confirm('是否确认发布？', {\n                                    okCls: '',\n                                    ok: function() {\n                                        if (finished) {\n                                            publishTopic(formData);\n                                        } else {\n                                            // LEEROY JEEEEEEENKIIIIIIIIIIIIIIINS！\n                                        }\n                                    }\n                                });\n                            }\n                        } else {\n                            alert(data.message)\n                        }\n                    })\n                }\n            });\n        } else {\n            confirm('是否确认发布？', {\n                okCls: '',\n                ok: function() {\n                    if (finished) {\n                        publishTopic(formData);\n                    } else {\n                        // LEEROY JEEEEEEENKIIIIIIIIIIIIIIINS！\n                    }\n                }\n            });\n        }\n    }\n\n});\n\n\n// WEBPACK FOOTER //\n// ./src/js/page/issuePreview/index.js"],"sourceRoot":""}